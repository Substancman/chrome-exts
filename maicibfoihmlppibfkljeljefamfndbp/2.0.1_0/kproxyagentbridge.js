"\x75\x73\x65\x20\x73\x74\x72\x69\x63\x74";function KProxyAgentBridge(socketId,kproxyAgent){this.kproxyAgent=kproxyAgent;this.socketId=socketId;this.socketStream= new SocketStream(socketId);this.headersReader=null;this.responseHeaders=null;this.serverConnection=null;this.method=null;this.response=null;this.id=KProxyAgentBridge.id++}KProxyAgentBridge.id=0;KProxyAgentBridge.prototype={run:function(){var that=this;this.headersReader= new HeadersReader(this.socketStream);this.headersReader.readHeaders(function(){that.method=Method.extractMethod(that.headersReader.operation);that.connectToServer()},function(){that.onClientError()})},connectToServer:function(){if(this.getProxyHost()!=null){this.connectToServerByProxy();return};this.serverConnection=ConnectionPool.getConnection(this.getSelectedKProxy(),this.getKProxyPort());var that=this;if(this.serverConnection.isConnected()){this.onConnectedToServer()}else {this.serverConnection.connect(function(){that.onConnectedToServer()},function(){that.manageKProxyConnectionError();that.onServerError()},true)}},connectToServerByProxy:function(){this.serverConnection=ConnectionPool.getConnection(this.getProxyHost(),this.getProxyPort(),this.getSelectedKProxy());var that=this;if(this.serverConnection.isConnected()){this.onConnectedToServer()}else {this.serverConnection.connect(function(){that.connectToProxy()},function(){that.manageKProxyConnectionError();that.onServerError()},false)}},connectToProxy:function(){var that=this;var connectHeaders= new HeadersReader(null);connectHeaders.operation="\x43\x4F\x4E\x4E\x45\x43\x54\x20"+that.getSelectedKProxy()+"\x3A"+that.getKProxyPort()+"\x20"+that.method.version;var userAgent=that.headersReader.getProperty("\x75\x73\x65\x72\x2D\x61\x67\x65\x6E\x74");if(userAgent!=null){connectHeaders.headers[connectHeaders.headers.length]="\x75\x73\x65\x72\x2D\x61\x67\x65\x6E\x74";connectHeaders.values[connectHeaders.values.length]=userAgent};connectHeaders.headers[connectHeaders.headers.length]="\x70\x72\x6F\x78\x79\x2D\x63\x6F\x6E\x6E\x65\x63\x74\x69\x6F\x6E";connectHeaders.values[connectHeaders.values.length]="\x6B\x65\x65\x70\x2D\x61\x6C\x69\x76\x65";var proxyAuth=that.headersReader.getProperty("\x70\x72\x6F\x78\x79\x2D\x61\x75\x74\x68\x6F\x72\x69\x7A\x61\x74\x69\x6F\x6E");if(proxyAuth!=null){connectHeaders.headers[connectHeaders.headers.length]="\x70\x72\x6F\x78\x79\x2D\x61\x75\x74\x68\x6F\x72\x69\x7A\x61\x74\x69\x6F\x6E";connectHeaders.values[connectHeaders.values.length]=proxyAuth};that.serverConnection.getSocketStream().writeln(connectHeaders.toString(),function(){that.manageConnectionResponse(function(){that.serverConnection.getSocketStream().convertToSSL(function(){that.onConnectedToServer()},function(){that.manageKProxyConnectionError();that.onServerError()})},function(){that.manageKProxyConnectionError();that.onServerError()})},function(){that.manageKProxyConnectionError();that.onServerError()})},manageConnectionResponse:function(callback,error){var that=this;var connectionResponseHeaders= new HeadersReader(that.serverConnection.getSocketStream());connectionResponseHeaders.readHeaders(function(){if(connectionResponseHeaders.operation.indexOf("\x32\x30\x30")== -1){if(connectionResponseHeaders.operation.indexOf("\x34\x30\x37")==-1&&that.kproxyAgent.check407){that.kproxyAgent.notify407Pass()};var length=connectionResponseHeaders.getProperty("\x63\x6F\x6E\x74\x65\x6E\x74\x2D\x6C\x65\x6E\x67\x74\x68");var response=Response.extractResponse(connectionResponseHeaders.operation);var bClose=connectionResponseHeaders.getProperty("\x63\x6F\x6E\x6E\x65\x63\x74\x69\x6F\x6E")=="\x63\x6C\x6F\x73\x65"||connectionResponseHeaders.getProperty("\x70\x72\x6F\x78\x79\x2D\x63\x6F\x6E\x6E\x65\x63\x74\x69\x6F\x6E")=="\x63\x6C\x6F\x73\x65"||!response.isResponseHTTP11();that.socketStream.writeln(connectionResponseHeaders.toString(),function(){if(length!=null){var inputOutput= new InputOutputContentLength(that.serverConnection.getSocketStream(),that.socketStream,length);inputOutput.run(function(){if(bClose){that.socketStream.close()}else {that.continueManageConnectionResponse()}},function(){error()})}else {if(bClose){that.socketStream.close()}else {that.continueManageConnectionResponse(error)}}},function(){error()})}else {if(that.kproxyAgent.check407){that.kproxyAgent.notify407Pass()};callback()}},function(){error()})},continueManageConnectionResponse:function(error){var that=this;this.headersReader= new HeadersReader(this.socketStream);this.headersReader.readHeaders(function(){that.method=Method.extractMethod(that.headersReader.operation);that.connectToProxy()},function(){error()})},onConnectedToServer:function(){if(this.method.isTunnel()){this.openTunnel()}else {this.sendRequest()}},sendRequest:function(){var that=this;this.serverConnection.getSocketStream().writeln("\x4B\x50\x52\x4F\x58\x59\x5F\x43\x4F\x4E\x4E\x45\x43\x54\x40"+this.getLoginPassword()+"\x20"+that.method.url,function(){that.checkConnectionReply(function(){that.headersReader.removeProperty("\x61\x63\x63\x65\x70\x74\x2D\x65\x6E\x63\x6F\x64\x69\x6E\x67");that.serverConnection.getSocketStream().writeln(that.headersReader.toString(),function(){var length=that.headersReader.getProperty("\x63\x6F\x6E\x74\x65\x6E\x74\x2D\x6C\x65\x6E\x67\x74\x68");if(length!=null){var inputOutput= new InputOutputContentLength(that.socketStream,that.serverConnection.getSocketStream(),length);inputOutput.run(function(){that.onRequestSent()},function(){that.onServerError()})}else {that.onRequestSent()}},function(){that.onServerError()})})},function(){that.onServerError()})},checkConnectionReply:function(callback){var that=this;this.serverConnection.getSocketStream().readln(function(strLine){if(strLine.indexOf("\x4B\x50\x53\x42\x3A\x20\x46\x41\x49\x4C")==0){that.manageKProxyError(strLine);that.onServerError()}else {if(!strLine.indexOf("\x4B\x50\x53\x42\x3A\x20\x4F\x4B")==0){that.manageKProxyProtocolError();that.onServerError()}else {callback()}}},function(){that.onServerError()})},onRequestSent:function(){this.readResponse()},readResponse:function(){this.responseHeaders= new HeadersReader(this.serverConnection.getSocketStream());var that=this;this.responseHeaders.readHeaders(function(){that.response=Response.extractResponse(that.responseHeaders.operation);var connection=that.responseHeaders.getProperty("\x63\x6F\x6E\x6E\x65\x63\x74\x69\x6F\x6E");var proxyConnection=that.responseHeaders.getProperty("\x70\x72\x6F\x78\x79\x2D\x63\x6F\x6E\x6E\x65\x63\x74\x69\x6F\x6E");var bClose=false;if((connection!=null&&connection=="\x63\x6C\x6F\x73\x65")||(proxyConnection!=null&&proxyConnection=="\x63\x6C\x6F\x73\x65")||!that.response.isResponseHTTP11()){bClose=true};var inputOutput=null;var length=that.responseHeaders.getProperty("\x63\x6F\x6E\x74\x65\x6E\x74\x2D\x6C\x65\x6E\x67\x74\x68");if(length==null){var chunk=that.responseHeaders.getProperty("\x74\x72\x61\x6E\x73\x66\x65\x72\x2D\x65\x6E\x63\x6F\x64\x69\x6E\x67");if(chunk!=null&&chunk=="\x63\x68\x75\x6E\x6B\x65\x64"){inputOutput= new InputOutputChunked(that.serverConnection.socketStream,that.socketStream)}else {if(chunk!=null&&chunk=="\x63\x68\x75\x6E\x6B\x65\x64\x6B\x70\x72\x6F\x78\x79"){inputOutput= new InputOutputChunkedToPlain(that.serverConnection.socketStream,that.socketStream);that.responseHeaders.removeProperty("\x74\x72\x61\x6E\x73\x66\x65\x72\x2D\x65\x6E\x63\x6F\x64\x69\x6E\x67")}}}else {inputOutput= new InputOutputContentLength(that.serverConnection.socketStream,that.socketStream,length)};that.socketStream.writeln(that.responseHeaders.toString(),function(){if(inputOutput!=null){var socketId=that.serverConnection.socketId;inputOutput.run(function(){that.onResponseSent(bClose)},function(){that.onServerError()})}else {that.onResponseSent(bClose)}},function(){that.onServerError()})},function(){that.onServerError()})},onResponseSent:function(bClose){if(!bClose){ConnectionPool.releaseConnection(this.serverConnection)}else {this.serverConnection.close()};this.serverConnection=null;this.headersReader=null;this.responseHeaders=null;this.method=null;this.response=null;var that=this;var newRun=function(){that.run()};setTimeout(newRun,0)},openTunnel:function(){var that=this;this.serverConnection.getSocketStream().writeln("\x4B\x50\x52\x4F\x58\x59\x5F\x43\x4F\x4E\x4E\x45\x43\x54\x5F\x54\x55\x4E\x4E\x45\x4C\x40"+this.getLoginPassword()+"\x20"+this.method.url,function(){that.checkConnectionReply(function(){{that.socketStream.writeln(that.method.version+"\x20\x32\x30\x30\x20\x43\x6F\x6E\x6E\x65\x63\x74\x69\x6F\x6E\x20\x65\x73\x74\x61\x62\x6C\x69\x73\x68\x65\x64\x0D\x0A",function(){that.startTunnel()},function(){that.onServerError()})}})},function(){that.onServerError()})},startTunnel:function(){var httpTunnel= new HTTPTunnel(this.socketStream,this.serverConnection.getSocketStream());httpTunnel.run()},onClientError:function(){this.socketStream.close()},onServerError:function(){this.socketStream.close();if(this.serverConnection.isConnected()){this.serverConnection.close()}},manageKProxyError:function(strError){if(strError.indexOf("\x4B\x50\x53\x42\x2D\x4C\x6F\x67\x69\x6E")> -1){this.kproxyAgent.sendMessageToExtension({loginError:true})}else {if(strError.indexOf("\x4B\x50\x53\x42\x2D\x41\x63\x63\x65\x73\x73")> -1){this.kproxyAgent.sendMessageToExtension({accessError:true})}else {}}},manageKProxyProtocolError:function(){},manageKProxyConnectionError:function(){},getSelectedKProxy:function(){return this.kproxyAgent.currentKProxyServer},getKProxyPort:function(){return 443},getLoginPassword:function(){var str="\x2A\x74\x65\x73\x74\x75\x73\x65\x72\x23"+"\x5F\x5F\x5F\x4B\x50\x41\x5F\x4D\x41\x43\x5F\x5F\x5F"+this.getSystemId();if(this.kproxyAgent.user!=null&&this.kproxyAgent.user.login!=null){str=(this.kproxyAgent.user.login+"\x23"+this.kproxyAgent.user.passwd+"\x5F\x5F\x5F\x4B\x50\x41\x5F\x4D\x41\x43\x5F\x5F\x5F"+this.getSystemId())};return str},getSystemId:function(){return "\x63\x68\x72\x6F\x6D\x65\x61\x70\x70\x5F"+this.kproxyAgent.mac},getProxyHost:function(){return this.kproxyAgent.currentProxyAddress},getProxyPort:function(){return this.kproxyAgent.currentProxyPort}};function Method(){this.protocol=null;this.url=null;this.version="";this.connectionEstablished=false;this.isTunnel=function(){return this.protocol=="\x43\x4F\x4E\x4E\x45\x43\x54"}}Method.extractMethod=function(str){var m= new Method();var strSplit=str.split("\x20");var strHeader=strSplit[1].trim();m.protocol=strSplit[0].trim().toUpperCase();m.version=strSplit[2].trim();if(m.isTunnel()){m.url=strHeader}else {var index=strHeader.indexOf("\x2F\x2F");if(index> -1){strHeader=strHeader.substring(index+2)};index=strHeader.indexOf("\x2F");strHeader=strHeader.substring(0,index);m.url=strHeader};return m};function Response(){this.protocol=null;this.code=0;this.isResponseHTTP11=function(){return this.protocol.toUpperCase()=="\x48\x54\x54\x50\x2F\x31\x2E\x31"}}Response.extractResponse=function(str){var r= new Response();var strSplit=str.split("\x20");r.protocol=strSplit[0].trim();r.code=strSplit[1].trim();return r};function HeadersReader(socketStream){this.socketStream=socketStream;this.headers= new Array();this.values= new Array();this.operation=null;this.onHeadersRead=null}HeadersReader.prototype={readHeaders:function(callback,error){this.onHeadersRead=callback;this.onHeadersReadError=error;this.readLine()},readLine:function(){var that=this;this.socketStream.readln(function(strLine){that.onLineRead(strLine)},function(){that.onHeadersReadError()})},onLineRead:function(strLine){if(this.operation==null){this.operation=strLine}else {if(strLine.length==0){this.onHeadersRead();return}else {var i=strLine.indexOf("\x3A");var strHeader=strLine.substring(0,i);var strValue=strLine.substring(i+1).trim();var index=this.headers.length;this.headers[index]=strHeader;this.values[index]=strValue}};this.readLine()},toString:function(){var str=this.operation+"\x0D\x0A";for(var i=0;i<this.headers.length;i++){str+=this.headers[i]+"\x3A\x20"+this.values[i]+"\x0D\x0A"};return str},getProperty:function(strKey){strKey=strKey.toLowerCase();for(var i=0;i<this.headers.length;i++){if(this.headers[i].toLowerCase()==strKey){return this.values[i]}};return null},setProperty:function(strKey,value){strKey=strKey.toLowerCase();for(var i=0;i<this.headers.length;i++){if(this.headers[i].toLowerCase()==strKey){this.values[i]=value;return}};var index=this.headers.length;this.headers[index]=strKey;this.values[index]=value},removeProperty:function(strKey){strKey=strKey.toLowerCase();for(var i=0;i<this.headers.length;i++){if(this.headers[i].toLowerCase()==strKey){this.headers.splice(i,1);this.values.splice(i,1)}}}}